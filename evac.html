<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incident Map & Evacuation Info</title>

  <!-- DNS prefetch & preconnect for external resources -->
  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="dns-prefetch" href="//cms9files.revize.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>

  <!-- Critical CSS inline for fastest first paint -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.2);box-shadow:0 2px 10px rgba(0,0,0,0.25);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    #viewDiv{width:100%;height:460px;background:#e5e5e5}
  </style>

  <!-- Non-critical CSS loaded async -->
  <link rel="stylesheet" href="shared-styles.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="shared-styles.css"></noscript>

  <!-- ArcGIS CSS - loaded async -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css"></noscript>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img
            src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
            alt="La Plata County Logo"
            class="header-logo"
            width="260"
            height="auto"
            loading="eager"
            fetchpriority="high"
            decoding="async"
          >
          <div class="site-title">ReadyLaPlata<span class="title-break"> ‚Äî </span><span class="title-sub">La Plata County Evacuation Viewer</span></div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
            <div class="incident-actions">
              <button id="infoButton" class="info-link" type="button" aria-label="Evacuation Information">
                <span class="info-icon-home">üè†</span>
                <span class="info-label">Evacuation Information</span>
              </button>
              <button id="coderedButton" class="alert-link" type="button" aria-label="CodeRED Alerts">
                üîî CodeRED Alerts
              </button>
            </div>
          </div>

          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none">No active incidents are listed.</div>
        </div>

        <div class="card-divider"></div>
        <div id="viewDiv"></div>

        <div class="map-key-merged">
          <div class="legend-title">Map Key</div>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-icon-road"></span>
              <span>Road closure</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon-info">i</span>
              <span>Information</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon-warning"></span>
              <span>Special warning</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">Loading evacuation information‚Ä¶</div>
      <div class="incident-panel">
        <div id="incident-panel">Loading incident status‚Ä¶</div>
      </div>
    </main>
  </div>

  <!-- CodeRED Overlay (shared with info.html) -->
  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close CodeRED info">√ó</button>
      <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
      <p class="codered-subtitle">Get emergency notifications for La Plata County</p>
      <div class="codered-body">
        <ul>
          <li><strong>Sign up online:</strong> <a href="https://public.coderedweb.com/CNE/en-US/655AC5D55998" target="_blank" rel="noopener">CodeRED Portal</a></li>
          <li><strong>Text to enroll:</strong> Text <strong>LPCOEM</strong> to <strong>99411</strong></li>
          <li><strong>Already have CodeRED?</strong> Log in to update your address or notification preferences.</li>
        </ul>
      </div>
      <div class="codered-actions">
        <a class="codered-primary" href="https://public.coderedweb.com/CNE/en-US/655AC5D55998" target="_blank" rel="noopener">Open CodeRED Portal</a>
        <button id="coderedCloseBottom" class="codered-secondary" type="button">Close</button>
      </div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.31/"></script>
  <script>
    (() => {
      const CONFIG = {
        mapUrl: 'evac.html',
        incidentLayerUrl: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/Evacuation_Zone_View_Public/FeatureServer/0',
        incidentField: 'ZoneName',
        statusLayerUrl: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/Emergency_Notifications/FeatureServer/0',
        statusFields: ['title', 'timestamp', 'description'],
        statusMaxFeatures: 5,
        evacTableUrl: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/Evacuation_Information/FeatureServer/0'
      };

      const DOM = {};

      const INCIDENT = (() => {
        try {
          const p = new URLSearchParams(location.search);
          const inc = (p.get('incident') || p.get('Incident') || '').trim();
          return inc || null;
        } catch { return null; }
      })();

      function cacheDOM() {
        DOM.viewDiv = document.getElementById('viewDiv');
        DOM.evacRow = document.getElementById('evacRow');
        DOM.incidentPanel = document.getElementById('incident-panel');
        DOM.chipsEl = document.getElementById('incidentChips');
        DOM.countBadge = document.getElementById('incidentCountBadge');
        DOM.noIncidentsMsg = document.getElementById('noIncidentsMsg');
        DOM.infoButton = document.getElementById('infoButton');
        DOM.coderedButton = document.getElementById('coderedButton');
        DOM.coderedOverlay = document.getElementById('coderedOverlay');
        DOM.coderedClose = document.getElementById('coderedClose');
        DOM.coderedCloseBottom = document.getElementById('coderedCloseBottom');

        if (DOM.infoButton) {
          DOM.infoButton.addEventListener('click', () => {
            const url = new URL('info.html', location.href);
            if (INCIDENT) url.searchParams.set('incident', INCIDENT);
            location.href = url;
          });
        }

        if (DOM.coderedCloseBottom && DOM.coderedClose) {
          DOM.coderedCloseBottom.addEventListener('click', () => DOM.coderedClose.click());
        }
      }

      async function loadIncidentStatus() {
        if (!DOM.incidentPanel) return;

        const params = new URLSearchParams({
          where: '1=1',
          orderByFields: 'timestamp DESC',
          outFields: CONFIG.statusFields.join(','),
          resultRecordCount: CONFIG.statusMaxFeatures,
          f: 'json'
        });

        try {
          const res = await fetch(`${CONFIG.statusLayerUrl}/query?${params}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const features = data.features || [];

          if (!features.length) {
            DOM.incidentPanel.innerHTML = '<div class="status-empty">No incident updates available.</div>';
            return;
          }

          const list = document.createElement('ul');
          list.className = 'status-list';

          features.forEach(f => {
            const attrs = f.attributes || {};
            const li = document.createElement('li');
            li.className = 'status-card';

            const title = attrs.title || 'Status update';
            const desc = attrs.description || 'No description provided.';
            const ts = attrs.timestamp ? new Date(attrs.timestamp).toLocaleString() : 'Unknown time';

            li.innerHTML = `
              <div class="status-title">${title}</div>
              <div class="status-time">${ts}</div>
              <div class="status-body">${desc}</div>
            `;
            list.appendChild(li);
          });

          DOM.incidentPanel.innerHTML = '';
          DOM.incidentPanel.appendChild(list);
        } catch (err) {
          console.error('Error loading incident status:', err);
          DOM.incidentPanel.innerHTML = '<div class="status-error">Unable to load incident updates.</div>';
        }
      }

      async function loadEvacuationZones() {
        if (!DOM.evacRow) return;

        const params = new URLSearchParams({
          where: '1=1',
          outFields: '*',
          orderByFields: 'OrderBy ASC',
          f: 'json'
        });

        try {
          const res = await fetch(`${CONFIG.evacTableUrl}/query?${params}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const features = data.features || [];
          if (!features.length) {
            DOM.evacRow.textContent = 'No evacuation information is available.';
            return;
          }

          const fragment = document.createDocumentFragment();

          const addColumn = (title, icon, content) => {
            const col = document.createElement('div');
            col.className = 'evac-col';
            col.innerHTML = `
              <div class="evac-title">
                <span class="evac-icon">${icon}</span>
                <span>${title}</span>
              </div>
              <div class="evac-content">${content}</div>
            `;
            fragment.appendChild(col);
          };

          features.forEach(f => {
            const attrs = f.attributes || {};
            addColumn(attrs.Title || 'Evacuation Info', 'üìã', attrs.Description || 'No description');
            addColumn('Shelters', 'üè†', attrs.Shelters || 'No shelter information');
            addColumn('Livestock', 'üê¥', attrs.Livestock || 'No livestock guidance');
            addColumn('Road Closures', 'üöß', attrs.RoadClosures || 'No road closure info');
          });

          DOM.evacRow.innerHTML = '';
          DOM.evacRow.appendChild(fragment);
        } catch (err) {
          console.error('Error loading evac table:', err);
          DOM.evacRow.textContent = 'Unable to load evacuation information.';
        }
      }

      const escapeQuery = (str = '') =>
        str.replace(/'/g, "''");

      function initMap() {
        require([
          'esri/Map',
          'esri/views/MapView',
          'esri/layers/FeatureLayer',
          'esri/widgets/Search',
          'esri/widgets/Fullscreen'
        ], (Map, MapView, FeatureLayer, Search, Fullscreen) => {

          const map = new Map({ basemap: 'topo-vector' });
          const view = new MapView({
            container: DOM.viewDiv,
            map,
            center: [-107.9, 37.27],
            zoom: 9
          });

          const incidentLayer = new FeatureLayer({
            url: CONFIG.incidentLayerUrl,
            title: 'Incidents',
            outFields: [CONFIG.incidentField],
            popupEnabled: true,
            popupTemplate: {
              title: '{' + CONFIG.incidentField + '}',
              content: 'Tap the incident chip above to zoom.'
            }
          });

          const statusLayer = new FeatureLayer({
            url: CONFIG.statusLayerUrl,
            title: 'Emergency Notifications',
            outFields: CONFIG.statusFields,
            popupEnabled: true,
            popupTemplate: {
              title: '{title}',
              content: '{description}',
              fieldInfos: [
                {
                  fieldName: 'timestamp',
                  label: 'Updated',
                  format: {
                    dateFormat: 'short-date-short-time'
                  }
                }
              ]
            },
            visible: false,
            listMode: 'hide'
          });
          map.add(statusLayer);

          const roadClosureLayer = new FeatureLayer({
            url: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/LPC_Road_Closures_2024/FeatureServer/0',
            title: 'Road Closures',
            outFields: ['*'],
            popupEnabled: true,
            popupTemplate: {
              title: '{Location}',
              content: `
                <div><strong>Status:</strong> {Status}</div>
                <div><strong>Reason:</strong> {Reason}</div>
                <div><strong>Updated:</strong> {Date_}</div>
              `
            }
          });
          map.add(roadClosureLayer);

          const infoLayer = new FeatureLayer({
            url: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/LPC_Information_Locations_View_Public/FeatureServer/0',
            title: 'Information Points',
            outFields: ['*'],
            popupEnabled: true,
            popupTemplate: {
              title: '{LocationName}',
              content: '{Details}'
            }
          });
          map.add(infoLayer);

          const warnLayer = new FeatureLayer({
            url: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/LPC_Special_Warnings/FeatureServer/0',
            title: 'Special Warnings',
            outFields: ['*'],
            popupEnabled: true,
            popupTemplate: {
              title: '{Title}',
              content: '{Description}'
            }
          });
          map.add(warnLayer);

          const evacLayer = new FeatureLayer({
            url: CONFIG.incidentLayerUrl,
            title: 'Evacuation Zones',
            outFields: [CONFIG.incidentField],
            popupEnabled: true,
            popupTemplate: {
              title: '{' + CONFIG.incidentField + '}',
              content: `
                <div>Check the incident chips above to zoom to this zone.</div>
                <div><em>Zone polygons may update during an incident.</em></div>
              `
            },
            renderer: {
              type: 'simple',
              symbol: {
                type: 'simple-fill',
                color: [255, 170, 0, 0.12],
                outline: {
                  color: [255, 120, 0, 0.7],
                  width: 1.5
                }
              }
            },
            opacity: 0.6,
            listMode: 'hide'
          });
          map.add(evacLayer);

          const incidentLayer2 = new FeatureLayer({
            url: CONFIG.incidentLayerUrl,
            title: 'Incident Names',
            outFields: [CONFIG.incidentField],
            labelingInfo: [{
              labelExpressionInfo: { expression: `$feature.${CONFIG.incidentField}` },
              symbol: {
                type: 'text',
                color: '#b33a3a',
                haloColor: '#fff',
                haloSize: '2px',
                font: { size: 12, weight: 'bold' }
              }
            }],
            renderer: {
              type: 'simple',
              symbol: {
                type: 'simple-fill',
                color: [0, 0, 0, 0],
                outline: { color: [0, 0, 0, 0] }
              }
            },
            minScale: 0,
            maxScale: 0,
            opacity: 0.9,
            listMode: 'hide'
          });
          map.add(incidentLayer2);

          const incidentLayer = new FeatureLayer({
            url: CONFIG.incidentLayerUrl,
            title: 'Incidents',
            outFields: [CONFIG.incidentField],
            popupEnabled: true,
            popupTemplate: {
              title: '{' + CONFIG.incidentField + '}',
              content: 'Tap the incident chip above to zoom.'
            },
            renderer: {
              type: 'simple',
              symbol: {
                type: 'simple-marker',
                color: '#b33a3a',
                size: '10px',
                outline: {
                  color: '#fff',
                  width: 1.5
                }
              }
            },
            listMode: 'hide'
          });
          webmap.add(incidentLayer);

          const zoomToIncident = name => {
            const where = `${CONFIG.incidentField} = '${escapeQuery(name)}'`;
            return incidentLayer.queryExtent({ where })
              .then(res => res.extent && view.goTo(res.extent.expand(1.2)))
              .catch(console.error);
          };

          view.when()
            .then(() => {
              view.ui.add(new Search({ view, includeDefaultSources: true }), 'top-right');
              view.ui.add(new Fullscreen({ view }), 'top-right');
              return incidentLayer.when();
            })
            .then(() => incidentLayer.queryFeatures({
              where: '1=1',
              outFields: [CONFIG.incidentField],
              returnDistinctValues: true,
              orderByFields: [CONFIG.incidentField]
            }))
            .then(fs => {
              const names = (fs.features || [])
                .map(f => f.attributes[CONFIG.incidentField])
                .filter(Boolean);

              DOM.countBadge.textContent = names.length;

              if (!names.length) {
                DOM.noIncidentsMsg.style.display = 'block';
                return;
              }
              DOM.noIncidentsMsg.style.display = 'none';

              const target = INCIDENT?.toLowerCase();
              names.sort((a, b) => {
                const al = a.toLowerCase(), bl = b.toLowerCase();
                if (target) {
                  if (al === target && bl !== target) return -1;
                  if (bl === target && al !== target) return 1;
                }
                return al.localeCompare(bl);
              });

              const frag = document.createDocumentFragment();
              names.forEach(name => {
                const chip = document.createElement('button');
                chip.className = 'incident-chip';
                chip.dataset.incident = name;
                chip.innerHTML = `<span class="incident-chip-dot"></span><span>${name}</span>`;
                chip.addEventListener('click', () => {
                  const url = new URL(location.href);
                  url.searchParams.set('incident', name);
                  location.href = url;
                });
                frag.appendChild(chip);
              });
              DOM.chipsEl.appendChild(frag);

              if (INCIDENT) {
                const match = DOM.chipsEl.querySelector(`[data-incident="${INCIDENT}"]`);
                if (match) {
                  match.classList.add('active');
                  zoomToIncident(INCIDENT);
                }
              }
            })
            .catch(err => {
              console.error('Error loading incidents:', err);
              DOM.countBadge.textContent = '0';
            });
        });
      }

      // ========== CODERED OVERLAY INIT ==========
      function initCoderedOverlay() {
        if (!DOM.coderedButton || !DOM.coderedOverlay) return;

        const open = () => {
          DOM.coderedOverlay.classList.add('is-open');
          DOM.coderedOverlay.setAttribute('aria-hidden', 'false');
        };

        const close = () => {
          DOM.coderedOverlay.classList.remove('is-open');
          DOM.coderedOverlay.setAttribute('aria-hidden', 'true');
        };

        DOM.coderedButton.addEventListener('click', open);
        if (DOM.coderedClose) DOM.coderedClose.addEventListener('click', close);

        DOM.coderedOverlay.addEventListener('click', (e) => {
          if (e.target === DOM.coderedOverlay) {
            close();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && DOM.coderedOverlay.classList.contains('is-open')) {
            close();
          }
        });
      }

      // ========== INIT ==========
      function init() {
        cacheDOM();
        initCoderedOverlay();
        loadEvacuationZones();
        loadIncidentStatus();
        initMap();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

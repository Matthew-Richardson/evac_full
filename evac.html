<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Incident Map & Evacuation Info</title>

  <!-- Resource hints for faster loading on slow connections -->
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://cms9files.revize.com">

  <!-- Shared styles (cached across pages) -->
  <link rel="stylesheet" href="shared-styles.css">

  <!-- ArcGIS CSS - loaded early for map rendering -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css">

  <!-- Critical inline styles for instant first paint -->
  <style>
    #viewDiv{width:100%;height:460px}
    .loading-placeholder{height:460px;display:flex;align-items:center;justify-content:center;background:#f0f0f0;color:#666}
  </style>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img
            src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
            alt="La Plata County Logo"
            class="header-logo"
            width="260" height="auto"
            loading="eager"
            fetchpriority="high"
          >
          <div class="site-title">ReadyLaPlata ‚Äî La Plata County Evacuation Viewer</div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
            <button id="infoButton" class="info-link" type="button" aria-label="Evacuation Information">
              <span class="info-icon-home">üè†</span>
              <span class="info-label">Evacuation Information</span>
            </button>
          </div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none">No active incidents are listed.</div>
        </div>

        <div class="card-divider"></div>

        <div id="viewDiv"><div class="loading-placeholder">Loading map‚Ä¶</div></div>

        <div class="map-key-merged">
          <div class="legend-title">Map Key</div>
          <div class="legend-items">
            <div class="legend-item"><span class="legend-icon-road"></span><span>Road closure</span></div>
            <div class="legend-item"><span class="legend-icon-info">i</span><span>Information</span></div>
            <div class="legend-item"><span class="legend-icon-warning"></span><span>Special warning</span></div>
          </div>
        </div>

      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">Loading evacuation information‚Ä¶</div>
      <div class="incident-panel">
        <div id="incident-panel">Loading incident status‚Ä¶</div>
      </div>
    </main>
  </div>

  <!-- Non-blocking data fetch runs immediately -->
  <script>
    // Configuration
    const CONFIG = {
      webmapId: "58a8bb313db64271a55e7960cb839f64",
      incidentLayerUrl: "https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0",
      incidentField: "incident",
      statusUrl: "https://script.google.com/macros/s/AKfycbxOFlSc6xXHqERr7n9VQbfnXnPGRqsvbgUs5lx4y6cy9YfnYSGFkLk5nSut66ecoRUwtA/exec"
    };

    const STATUS = {
      labels: { SET: "SET - Pre-Evacuation", GO: "GO - Evacuate Now" },
      colors: { SET: "#fff36a", GO: "#41f56e" },
      text: {
        SET: "Voluntary Evacuation;<br>Evacuation orders are likely",
        GO: "<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access."
      },
      values: { SET: "Set", GO: "Go" }
    };

    // Get incident from URL
    const INCIDENT = (() => {
      try {
        const p = new URLSearchParams(location.search);
        return (p.get("incident") || p.get("Incident") || "").trim() || null;
      } catch { return null; }
    })();

    const escapeQuery = s => s.replace(/'/g, "''");

    // DOM refs
    const evacRow = document.getElementById("evacRow");
    const incidentPanel = document.getElementById("incident-panel");

    function showHelp() {
      const helpHtml = `
        <div class="evac-box" style="background:#f3f4f6">
          <div class="evac-title">How to use this page</div>
          <div class="evac-body">
            <div>This evacuation information requires an <strong>incident name</strong> in the URL.</div>
            <div style="margin-top:8px">Use this format:<br><code>?incident=YourIncidentName</code></div>
            <div style="margin-top:8px">Example:<br><code>?incident=East%20Canyon</code></div>
          </div>
        </div>`;
      evacRow.innerHTML = helpHtml;
      incidentPanel.innerHTML = `
        <div class="evac-box" style="background:#f3f4f6">
          <div class="evac-title">Incident status</div>
          <div class="evac-body">
            <div>No incident was specified.</div>
            <div style="margin-top:8px">Append <code>?incident=YourIncidentName</code> to the URL.</div>
          </div>
        </div>`;
    }

    function buildBox(code, features) {
      const zones = !features?.length
        ? `<div class="evac-zones"><div class="no-zones-chip">No ${code} zones</div></div>`
        : `<div class="evac-zones">${features.map(f => `<div class="zone-chip">${f.attributes.zonename}</div>`).join("")}</div>`;

      const cls = code === "GO" ? " evac-box-go" : code === "SET" ? " evac-box-set" : "";

      return `
        <div class="evac-box${cls}" style="background:${STATUS.colors[code]}">
          <div class="evac-title">${STATUS.labels[code]}</div>
          <div class="evac-body">
            <div>The following zones are under ${code} status for <strong>${INCIDENT || "this incident"}</strong>.</div>
            ${zones}
            <div class="evac-note">${STATUS.text[code]}</div>
          </div>
        </div>`;
    }

    // Load evacuation zones (runs immediately)
    function loadEvacZones() {
      if (!INCIDENT) return showHelp();

      const where = `incident='${escapeQuery(INCIDENT)}' AND STATUS IN ('${STATUS.values.SET}','${STATUS.values.GO}')`;
      const url = `${CONFIG.incidentLayerUrl}/query?${new URLSearchParams({ where, outFields: "*", f: "json", returnGeometry: "false" })}`;

      fetch(url)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(data => {
          if (!data.features?.length) {
            evacRow.innerHTML = `<div class="evac-box" style="background:#fff36a"><div class="evac-title">No data</div><div class="evac-body">No zones found for <strong>${INCIDENT}</strong>.</div></div>`;
            return;
          }
          const setF = data.features.filter(f => f.attributes.STATUS === STATUS.values.SET);
          const goF = data.features.filter(f => f.attributes.STATUS === STATUS.values.GO);
          evacRow.innerHTML = buildBox("SET", setF) + buildBox("GO", goF);
        })
        .catch(e => {
          evacRow.innerHTML = `<div class="evac-box" style="background:#fff36a"><div class="evac-title">Error</div><div class="evac-body">Failed to load: ${e}</div></div>`;
        });
    }

    // Load incident status from Google Sheet
    function loadStatus() {
      if (!INCIDENT) return;

      fetch(`${CONFIG.statusUrl}?incident=${encodeURIComponent(INCIDENT)}`)
        .then(r => r.ok ? r.text() : Promise.reject(r.status))
        .then(html => {
          incidentPanel.innerHTML = `<div class="status-html">${html}</div>`;
          const stamp = document.createElement("div");
          stamp.className = "status-timestamp";
          stamp.innerHTML = `Last loaded: ${new Date().toLocaleString()} &nbsp;‚Ä¢&nbsp; <span class="source-label">Source: La Plata County Office of Emergency Management</span>`;
          incidentPanel.appendChild(stamp);
        })
        .catch(() => {
          incidentPanel.innerHTML = "<div>Error loading incident status.</div>";
        });
    }

    // Start data fetches immediately (don't wait for ArcGIS SDK)
    loadEvacZones();
    loadStatus();
  </script>

  <!-- ArcGIS SDK loaded with defer - won't block page render -->
  <script src="https://js.arcgis.com/4.31/" defer></script>

  <!-- Map initialization runs after SDK loads -->
  <script>
    // Wait for ArcGIS SDK
    function initMap() {
      if (typeof require === "undefined") {
        setTimeout(initMap, 50);
        return;
      }

      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Search",
        "esri/widgets/Fullscreen"
      ], (WebMap, MapView, FeatureLayer, Search, Fullscreen) => {

        const chipsEl = document.getElementById("incidentChips");
        const countBadge = document.getElementById("incidentCountBadge");
        const noMsg = document.getElementById("noIncidentsMsg");

        document.getElementById("infoButton").onclick = () => location.href = "info.html";

        const webmap = new WebMap({ portalItem: { id: CONFIG.webmapId } });

        const view = new MapView({
          container: "viewDiv",
          map: webmap
        });

        const incidentLayer = new FeatureLayer({
          url: CONFIG.incidentLayerUrl,
          outFields: ["*"],
          visible: false,
          listMode: "hide"
        });
        webmap.add(incidentLayer);

        const zoomTo = name => {
          const where = `${CONFIG.incidentField} = '${name.replace(/'/g, "''")}'`;
          incidentLayer.queryExtent({ where })
            .then(r => r.extent && view.goTo(r.extent.expand(1.2)))
            .catch(console.error);
        };

        view.when()
          .then(() => {
            view.ui.add(new Search({ view, includeDefaultSources: true }), "top-right");
            view.ui.add(new Fullscreen({ view }), "top-right");
            return incidentLayer.when();
          })
          .then(() => incidentLayer.queryFeatures({
            where: "1=1",
            outFields: [CONFIG.incidentField],
            returnDistinctValues: true,
            orderByFields: [CONFIG.incidentField]
          }))
          .then(fs => {
            const names = (fs.features || [])
              .map(f => f.attributes[CONFIG.incidentField])
              .filter(Boolean);

            countBadge.textContent = names.length;

            if (!names.length) {
              noMsg.style.display = "block";
              return;
            }
            noMsg.style.display = "none";

            // Sort: active incident first, then alphabetical
            if (INCIDENT) {
              const target = INCIDENT.toLowerCase();
              names.sort((a, b) => {
                if (a.toLowerCase() === target) return -1;
                if (b.toLowerCase() === target) return 1;
                return a.localeCompare(b);
              });
            } else {
              names.sort((a, b) => a.localeCompare(b));
            }

            names.forEach(name => {
              const chip = document.createElement("button");
              chip.className = "incident-chip";
              chip.dataset.incident = name;
              chip.innerHTML = `<span class="incident-chip-dot"></span><span>${name}</span>`;
              chip.onclick = () => {
                const url = new URL(location.href);
                url.searchParams.set("incident", name);
                location.href = url;
              };
              chipsEl.appendChild(chip);
            });

            if (INCIDENT) {
              const match = [...chipsEl.querySelectorAll(".incident-chip")]
                .find(el => el.dataset.incident?.toLowerCase() === INCIDENT.toLowerCase());
              if (match) {
                match.classList.add("active");
                zoomTo(INCIDENT);
              }
            }
          })
          .catch(e => {
            console.error("Error loading incidents:", e);
            countBadge.textContent = "0";
          });
      });
    }

    initMap();
  </script>
</body>
</html>

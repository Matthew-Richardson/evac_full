<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evacuation Information â€” ReadyLaPlata</title>

  <!-- Critical inline CSS to avoid FOUC -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:Arial,sans-serif;
      background:#f5f5f7;
      font-size:18px;
      overflow-x:hidden;
      color:#000;
    }
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.2);
      box-shadow:0 2px 10px rgba(0,0,0,0.25);
      overflow:hidden;
      background:#fff;
      display:flex;
      flex-direction:column;
    }
  </style>

  <link rel="stylesheet" href="shared-styles.css">
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img
            src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
            alt="La Plata County Logo"
            class="header-logo"
            width="260"
          >
          <div class="site-title">
            ReadyLaPlata â€” La Plata County Evacuation Viewer
          </div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
              <!-- CodeRED button now sits immediately to the right of "Active incidents" -->
              <button id="coderedButton" class="alert-link" type="button" aria-label="CodeRED Alerts">
                <span class="alert-icon">ðŸ””</span>
                <span class="alert-label">CodeRED Alerts</span>
              </button>
            </div>
          </div>

          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none">No active incidents are listed.</div>
        </div>

        <div class="card-divider"></div>
      </div>
    </div>

    <main>
      <div class="incident-panel">
        <div class="home-wrapper">

          <!-- TIMELINE BLOCK CARD -->
          <div class="preview-container">
            <div class="preview-frame">

              <div class="evac-stages">
                <div class="stage-header-main">
                  <div class="stage-tagline">La Plata County</div>
                  <div class="stage-headline">Stay Ready, Year-Round</div>
                  <div class="stage-body" style="margin-top:8px;max-width:780px;margin-left:auto;margin-right:auto;font-size:15px;line-height:1.5;">
                    <p>
                      La Plata County Office of Emergency Management (<strong>LPCOEM</strong>) â€” uses the Ready, Set, Go! system to establish evacuation zones.
                      Click the incident map above to confirm your zone. During an incident your zone name and area is subject to change.
                    </p>
                  </div>
                </div>

                <!-- Centered subheader -->
                <div class="stage-subhead">Ready, Set, Go! System</div>

                <div class="stage-timeline">

                  <!-- READY -->
                  <div class="stage-item">
                    <div class="stage-pin stage-pin-ready"></div>
                    <div class="stage-card stage-card-ready">
                      <h2 class="stage-title">READY</h2>
                      <div class="stage-subtitle">Be READY, Stay SAFE</div>
                      <div class="stage-body">
                        <p><strong>Stay Informed:</strong> CodeRED signup or text 'LPCOEM' to 99411, ensure Gov't Alerts are enabled on your cell phone, and use apps like Watch Duty.</p>
                        <p><strong>Arrangements:</strong> Make a plan and practice your evacuation; People, Pets, Photos, Papers and Pills.</p>
                        <p><strong>Pack Smart:</strong> Go-Bags ready with water, food, prescriptions, chargers, cash, ID.</p>
                        <p><strong>Vehicles:</strong> Keep fuel topped off (at least half-full) and keep vehicle accessible.</p>
                        <p><strong>Home Safety:</strong> Clear vegetation / debris away from home, outbuildings and propane tank.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Connector Ready -> Set -->
                  <div class="stage-connector stage-connector-ready-set"></div>

                  <!-- SET -->
                  <div class="stage-item">
                    <div class="stage-pin stage-pin-set"></div>
                    <div class="stage-card stage-card-set">
                      <h2 class="stage-title">SET</h2>
                      <div class="stage-subtitle">BE READY TO GO</div>
                      <div class="stage-body">
                        <p><strong>Stay Informed:</strong> Pack and prepare; confirm CodeRED and Watch Duty notifications are on.</p>
                        <p><strong>Pack and Prepare:</strong> Pack pets and valuables, load your vehicle, confirm evacuation routes, and choose a place to stay.</p>
                        <p><strong>Help Neighbors:</strong> Look out for neighbors who may need extra assistance.</p>
                        <p><strong>Execute Home Prep:</strong> Close garage, windows, doors, and gates. Move propane grill away from house.</p>
                        <p class="stage-body-center"><em>Gather essentials. Plan for pets. Leave early if you feel unsafe.</em></p>
                      </div>
                    </div>
                  </div>

                  <!-- Connector Set -> Go -->
                  <div class="stage-connector stage-connector-set-go"></div>

                  <!-- GO -->
                  <div class="stage-item">
                    <div class="stage-pin stage-pin-go"></div>
                    <div class="stage-card stage-card-go">
                      <h2 class="stage-title">GO</h2>
                      <div class="stage-subtitle">LEAVE IMMEDIATELY</div>
                      <div class="stage-body">
                        <p><strong>Evacuate Immediately:</strong> Leave now with your go-bags and pets.</p>
                        <p><strong>Stay Informed:</strong> Follow official instructions from LPCOEM, Sheriffâ€™s Office, Fire District, or other emergency officials.</p>
                        <p><strong>Check On Neighbors:</strong> Help neighbors if possible.</p>
                        <p><strong>Stay Clear:</strong> Do not return until authorities say it is safe.</p>
                        <p class="stage-body-center"><strong>Remember:</strong> Your life is the priority. Leave early; stay safe.</p>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              <!-- BASIC PREPAREDNESS GRID -->
              <div class="prep-grid">
                <div class="prep-card">
                  <h3>CodeRED Alerts</h3>
                  <p>Sign up for CodeRED alerts to receive emergency notifications.</p>
                  <p><strong>Sign up:</strong> <a href="https://public.coderedweb.com/CNE/en-US/655AC5D55998" target="_blank" rel="noopener">Online portal</a></p>
                  <p><strong>Text:</strong> Text <strong>LPCOEM</strong> to <strong>99411</strong></p>
                </div>
                <div class="prep-card">
                  <h3>Stay Connected</h3>
                  <p><strong>Watch Duty:</strong> Follow <a href="https://watchduty.org" target="_blank" rel="noopener">Watch Duty</a> for incident info.</p>
                  <p><strong>Social Media:</strong> Follow <a href="https://www.facebook.com/search/top?q=la%20plata%20county%20office%20of%20emergency%20management" target="_blank" rel="noopener">OEM Facebook</a> and local agencies.</p>
                  <p><strong>Local Media:</strong> Listen to local radio and check county updates.</p>
                </div>
                <div class="prep-card">
                  <h3>Evacuation Kit</h3>
                  <ul>
                    <li>Water, food, first aid</li>
                    <li>Medications & prescriptions</li>
                    <li>Important documents & IDs</li>
                    <li>Chargers & batteries</li>
                    <li>Cash & cards</li>
                    <li>Clothes & sturdy shoes</li>
                    <li>Pet supplies</li>
                  </ul>
                </div>
                <div class="prep-card">
                  <h3>Defensible Space</h3>
                  <p>Maintain defensible space around your home: clear leaves/debris, trim vegetation, and store flammables away from structures.</p>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- CodeRED Overlay (shared with evac.html) -->
  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close CodeRED info">Ã—</button>
      <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
      <p class="codered-subtitle">Get emergency notifications for La Plata County</p>
      <div class="codered-body">
        <ul>
          <li><strong>Sign up online:</strong> <a href="https://public.coderedweb.com/CNE/en-US/655AC5D55998" target="_blank" rel="noopener">CodeRED Portal</a></li>
          <li><strong>Text to enroll:</strong> Text <strong>LPCOEM</strong> to <strong>99411</strong></li>
          <li><strong>Already have CodeRED?</strong> Log in to update your address or notification preferences.</li>
        </ul>
      </div>
      <div class="codered-actions">
        <a class="codered-primary" href="https://public.coderedweb.com/CNE/en-US/655AC5D55998" target="_blank" rel="noopener">Open CodeRED Portal</a>
        <button id="coderedCloseBottom" class="codered-secondary" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const CONFIG = {
        incidentLayerUrl: 'https://services2.arcgis.com/eRFVaQ8rWUqS72mL/arcgis/rest/services/Evacuation_Zone_View_Public/FeatureServer/0',
        incidentField: 'ZoneName',
        mapUrl: 'evac.html'
      };

      const DOM = {
        chipsEl: document.getElementById('incidentChips'),
        countBadge: document.getElementById('incidentCountBadge'),
        noIncidentsMsg: document.getElementById('noIncidentsMsg'),
        coderedButton: document.getElementById('coderedButton'),
        coderedOverlay: document.getElementById('coderedOverlay'),
        coderedClose: document.getElementById('coderedClose')
      };

      const INCIDENT = (() => {
        try {
          const p = new URLSearchParams(location.search);
          const inc = (p.get('incident') || p.get('Incident') || '').trim();
          return inc || null;
        } catch { return null; }
      })();

      async function loadIncidents() {
        const params = new URLSearchParams({
          where: '1=1',
          outFields: CONFIG.incidentField,
          returnDistinctValues: 'true',
          f: 'json'
        });

        try {
          const res = await fetch(`${CONFIG.incidentLayerUrl}?${params}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const seen = new Set();

          const names = (data.features || [])
            .map(f => f.attributes?.[CONFIG.incidentField]?.trim())
            .filter(n => {
              if (!n) return false;
              const key = n.toLowerCase();
              if (seen.has(key)) return false;
              seen.add(key);
              return true;
            });

          const target = INCIDENT?.toLowerCase();
          names.sort((a, b) => {
            const al = a.toLowerCase(), bl = b.toLowerCase();
            if (target) {
              if (al === target && bl !== target) return -1;
              if (bl === target && al !== target) return 1;
            }
            return al.localeCompare(bl);
          });

          DOM.countBadge.textContent = names.length;

          if (!names.length) {
            DOM.noIncidentsMsg.style.display = 'block';
            return;
          }

          const frag = document.createDocumentFragment();
          names.forEach(name => {
            const chip = document.createElement('button');
            chip.className = 'incident-chip';
            chip.innerHTML = `<span class="incident-chip-dot"></span><span>${name}</span>`;
            chip.addEventListener('click', () => {
              const url = new URL(CONFIG.mapUrl, location.href);
              url.searchParams.set('incident', name);
              location.href = url;
            });
            frag.appendChild(chip);
          });

          DOM.chipsEl.appendChild(frag);

        } catch (err) {
          console.error(err);
          DOM.countBadge.textContent = '0';
          DOM.noIncidentsMsg.style.display = 'block';
        }
      }

      function initCoderedOverlay() {
        if (!DOM.coderedButton || !DOM.coderedOverlay) return;

        const open = () => {
          DOM.coderedOverlay.classList.add('is-open');
          DOM.coderedOverlay.setAttribute('aria-hidden', 'false');
        };

        const close = () => {
          DOM.coderedOverlay.classList.remove('is-open');
          DOM.coderedOverlay.setAttribute('aria-hidden', 'true');
        };

        DOM.coderedButton.addEventListener('click', open);
        if (DOM.coderedClose) DOM.coderedClose.addEventListener('click', close);

        DOM.coderedOverlay.addEventListener('click', (e) => {
          if (e.target === DOM.coderedOverlay) {
            close();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && DOM.coderedOverlay.classList.contains('is-open')) {
            close();
          }
        });
      }

      function init() {
        loadIncidents();
        initCoderedOverlay();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

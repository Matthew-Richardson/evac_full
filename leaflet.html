<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadyLaPlata — La Plata County Evacuation Viewer (Leaflet)</title>
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="description" content="Official evacuation information and interactive maps for La Plata County, Colorado.">
  <meta name="theme-color" content="#0b4da2">

  <!-- Leaflet CSS (~15KB) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.12);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    #map{width:100%;height:clamp(400px, 55vh, 550px);background:#e5e5e5;z-index:1}
    
    /* Header & Brand */
    .card-brand{padding:14px 18px 8px;display:flex;flex-direction:column;align-items:center;gap:4px}
    .header-logo{max-width:220px;width:60%;height:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.25))}
    .site-title{text-align:center;margin:4px 0;font-size:15px;font-weight:600;letter-spacing:0.04em;color:#6e6e6e;opacity:0.85;line-height:1.3}
    .call-center{background:#f5f7ff;padding:8px 16px;border-radius:8px;border:1px solid rgba(11,77,162,0.18);box-shadow:0 1px 3px rgba(0,0,0,0.12);display:flex;flex-direction:column;align-items:center;gap:2px;color:#333}
    .call-center strong{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;opacity:0.85}
    .call-center a{color:#0b4da2;text-decoration:none;font-weight:700;font-size:20px}
    .card-divider{margin:8px 14px 0;border-top:1px solid rgba(0,0,0,0.08)}

    /* Navigation */
    .incident-nav-centered{display:flex;justify-content:center;align-items:center;gap:8px;padding:8px 18px 10px;border-bottom:1px solid rgba(0,0,0,0.08)}
    .info-link,.alert-link{font-size:14px;padding:6px 10px;border-radius:8px;border:2px solid #0b4da2;background:#fff;color:#0b4da2;cursor:pointer;transition:background 0.2s,color 0.2s,box-shadow 0.2s;white-space:nowrap;display:inline-flex;align-items:center;gap:5px;flex-shrink:0;font-weight:600}
    .info-link:hover,.alert-link:hover{background:#0b4da2;border-color:#0b4da2;color:#fff;box-shadow:0 0 0 2px rgba(11,77,162,0.25)}
    .nav-icon{width:16px;height:16px;flex-shrink:0}

    /* Incident Strip */
    .incident-strip{padding:10px 18px}
    .incident-label{font-size:16px;font-weight:700;text-transform:uppercase;letter-spacing:0.04em;color:#b3261e;display:inline-flex;align-items:center;gap:6px}
    .incident-count-badge{padding:4px 12px;border-radius:999px;background:#b3261e;color:#fff;font-size:15px;font-weight:700;line-height:1.4}
    .incident-count-badge.has-incidents{animation:badgePulse 2s ease-in-out infinite}
    @keyframes badgePulse{0%,100%{box-shadow:0 0 0 0 rgba(179,38,30,0.5)}50%{box-shadow:0 0 0 6px rgba(179,38,30,0)}}
    .incident-tip{font-size:12px;color:#777;opacity:0.6;margin:2px 0 6px 2px}
    .incident-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .incident-chip{border-radius:8px;padding:6px 12px;border:1px solid #d0d0d0;background:#fff;font-size:17px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;color:#000;transition:background 0.15s,border-color 0.15s;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    .incident-chip:hover{background:#fff5f5;border-color:#e8b4b1}
    .incident-chip.active{background:#b3261e;border-color:#b3261e;color:#fff;font-weight:700}
    .incident-chip-icon{width:16px;height:16px;border-radius:50%;background:#b3261e;color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center}
    .incident-chip.active .incident-chip-icon{background:#fff;color:#b3261e}
    .incident-none{font-size:14px;color:#666;margin-top:4px;display:none}

    /* Map Legend */
    .map-key-merged{padding:16px 18px 18px;border-top:1px solid rgba(0,0,0,0.08);background:#fafafa;text-align:center}
    .map-key-merged .legend-title{font-weight:700;margin-bottom:10px;font-size:18px}
    .map-key-merged .legend-items{display:inline-flex;gap:20px;flex-wrap:wrap;justify-content:center}
    .map-key-merged .legend-item{display:flex;align-items:center;gap:8px;font-size:16px}
    .legend-color{width:20px;height:20px;border-radius:4px;border:2px solid rgba(0,0,0,0.3)}

    /* Evacuation Boxes */
    .evac-row{display:flex;gap:16px;max-width:900px;width:100%;padding:12px;flex-wrap:wrap;justify-content:center;margin:12px auto}
    .evac-box{padding:14px;border-radius:8px;box-shadow:0 0 5px rgba(0,0,0,0.25);flex:1;min-width:260px;border:1px solid rgba(0,0,0,0.2);background:#fff}
    .evac-box-set{border:3px solid rgba(180,150,0,0.9);box-shadow:0 0 10px rgba(180,150,0,0.45)}
    .evac-box-go{border:3px solid rgba(0,120,0,0.9);box-shadow:0 0 12px rgba(0,120,0,0.55);animation:goPulse 2.5s ease-in-out infinite alternate}
    @keyframes goPulse{from{box-shadow:0 0 8px rgba(0,120,0,0.4)}to{box-shadow:0 0 18px rgba(0,160,0,0.8)}}
    .evac-title{font-weight:700;font-size:18px;margin-bottom:8px}
    .evac-body{font-size:15px;line-height:1.5}
    .evac-zones{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .zone-chip,.no-zones-chip{font-weight:700;background:rgba(0,0,0,0.08);padding:4px 10px;border-radius:8px;font-size:15px}
    .evac-note{margin-top:10px;font-size:15px;font-style:italic;font-weight:700}

    /* Incident Panel */
    .incident-panel{max-width:900px;width:100%;padding:0 12px 20px;margin:0 auto 20px;font-size:18px;line-height:1.6}
    .status-timestamp{font-size:14px;margin-top:10px;color:#444;opacity:0.8;text-align:center}

    /* Performance Badge */
    .perf-badge{position:fixed;bottom:12px;right:12px;background:#0b4da2;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.3);z-index:1000}

    @media(max-width:600px){
      .evac-row{flex-direction:column}
      .evac-box{min-width:0}
      .header-logo{width:55%;max-width:200px}
      .site-title{font-size:13px}
    }
  </style>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="header-logo" width="260" height="auto">
          <div class="site-title">ReadyLaPlata — Evacuation Viewer <strong style="color:#0b4da2">(Leaflet)</strong></div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="incident-nav-centered">
          <button id="infoButton" class="info-link" type="button">
            <svg class="nav-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>Home</span>
          </button>
          <button id="overviewButton" class="info-link" type="button">
            <svg class="nav-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
            <span>Overview</span>
          </button>
        </div>

        <div class="incident-strip">
          <div class="incident-bar-left">
            <span class="incident-label">
              Active incidents
              <span id="incidentCountBadge" class="incident-count-badge">0</span>
            </span>
          </div>
          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none">✓ No active incidents.</div>
        </div>

        <div class="card-divider"></div>
        <div id="map"></div>

        <div class="map-key-merged">
          <div class="legend-title">Map Key</div>
          <div class="legend-items">
            <div class="legend-item"><span class="legend-color" style="background:#fff36a"></span><span>SET Zone</span></div>
            <div class="legend-item"><span class="legend-color" style="background:#41f56e"></span><span>GO Zone</span></div>
          </div>
        </div>
      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">Loading evacuation information…</div>
      <div class="incident-panel">
        <div id="incidentPanel">Loading incident status…</div>
      </div>
    </main>
  </div>

  <!-- Performance comparison badge -->
  <div class="perf-badge" id="perfBadge">Loading...</div>

  <!-- Leaflet JS (~40KB) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <!-- Esri Leaflet (~10KB) - connects Leaflet to ArcGIS services -->
  <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

  <script>
  (function() {
    'use strict';

    const startTime = performance.now();

    // ========== CONFIGURATION ==========
    const CONFIG = {
      featureServiceUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      statusBaseUrl: 'https://script.google.com/macros/s/AKfycbxOFlSc6xXHqERr7n9VQbfnXnPGRqsvbgUs5lx4y6cy9YfnYSGFkLk5nSut66ecoRUwtA/exec',
      incidentField: 'incident',
      statusValues: { SET: 'Set', GO: 'Go' },
      mapCenter: [37.2753, -107.8801],
      mapZoom: 10
    };

    const STATUS_STYLES = {
      Set: { color: '#a68f00', fillColor: '#fff36a', weight: 3, fillOpacity: 0.5 },
      Go: { color: '#0a7c25', fillColor: '#41f56e', weight: 3, fillOpacity: 0.6 }
    };

    const STATUS_DATA = {
      SET: { label: 'SET - Pre-Evacuation', color: '#fff36a', text: 'Voluntary Evacuation;<br>Evacuation orders are likely' },
      GO: { label: 'GO - Evacuate Now', color: '#41f56e', text: '<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access.' }
    };

    // ========== DOM ==========
    const $ = id => document.getElementById(id);
    const DOM = {};

    // ========== URL PARAMETER ==========
    const INCIDENT = (() => {
      const params = new URLSearchParams(location.search);
      const inc = (params.get('incident') || params.get('Incident') || '').trim();
      if (inc) document.title = `${inc} — ReadyLaPlata (Leaflet)`;
      return inc || null;
    })();

    // ========== UTILITIES ==========
    const escapeQuery = s => s.replace(/'/g, "''");

    const createChip = (name, onClick) => {
      const chip = document.createElement('button');
      chip.className = 'incident-chip';
      chip.dataset.incident = name;
      chip.innerHTML = `<span class="incident-chip-icon">!</span><span>${name}</span>`;
      chip.addEventListener('click', onClick);
      return chip;
    };

    // ========== HTML BUILDERS ==========
    const buildBox = (statusCode, features) => {
      const data = STATUS_DATA[statusCode];
      const hasFeatures = features?.length > 0;
      
      const zonesHTML = hasFeatures
        ? `<div class="evac-zones">${features.map(f => `<div class="zone-chip">${f.properties.zonename || 'Unknown'}</div>`).join('')}</div>`
        : `<div class="evac-zones"><div class="no-zones-chip">No ${statusCode} zones</div></div>`;

      const boxClass = statusCode === 'GO' ? ' evac-box-go' : statusCode === 'SET' ? ' evac-box-set' : '';

      return `<div class="evac-box${boxClass}" style="background:${data.color}">
        <div class="evac-title">${data.label}</div>
        <div class="evac-body">
          <div>The following zones are under ${statusCode} status for <strong>${INCIDENT || 'this incident'}</strong>.</div>
          ${zonesHTML}
          <div class="evac-note">${data.text}</div>
        </div>
      </div>`;
    };

    const showHelp = () => {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">How to use this page</div>
        <div class="evac-body">
          <div>This page requires an <strong>incident name</strong> in the URL.</div>
          <div style="margin-top:8px">Example: <code>?incident=East%20Canyon</code></div>
        </div>
      </div>`;
      DOM.incidentPanel.innerHTML = '';
    };

    // ========== MAP INITIALIZATION ==========
    let map, evacLayer;

    function initMap() {
      map = L.map('map', {
        center: CONFIG.mapCenter,
        zoom: CONFIG.mapZoom,
        scrollWheelZoom: window.innerWidth >= 700
      });

      // Add basemap (Esri Topo - free, no API key needed)
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri, HERE, Garmin, © OpenStreetMap contributors'
      }).addTo(map);

      // Load evacuation zones if incident specified
      if (INCIDENT) {
        loadEvacZonesOnMap();
      }
    }

    function loadEvacZonesOnMap() {
      const where = `${CONFIG.incidentField}='${escapeQuery(INCIDENT)}' AND STATUS IN ('${CONFIG.statusValues.SET}','${CONFIG.statusValues.GO}')`;

      evacLayer = L.esri.featureLayer({
        url: CONFIG.featureServiceUrl,
        where: where,
        style: feature => STATUS_STYLES[feature.properties.STATUS] || { color: '#666', fillColor: '#ccc', weight: 2, fillOpacity: 0.3 }
      }).addTo(map);

      evacLayer.on('load', () => {
        // Fit map to zones
        const bounds = evacLayer.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        }
      });

      // Popup on click
      evacLayer.bindPopup(layer => {
        const p = layer.feature.properties;
        return `<strong>${p.zonename || 'Zone'}</strong><br>Status: ${p.STATUS}`;
      });
    }

    // ========== DATA FETCHING ==========
    async function loadIncidents() {
      const params = new URLSearchParams({
        where: '1=1',
        outFields: CONFIG.incidentField,
        returnDistinctValues: 'true',
        returnGeometry: 'false',
        f: 'json'
      });

      try {
        const res = await fetch(`${CONFIG.featureServiceUrl}/query?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const names = [...new Set(
          (data.features || [])
            .map(f => f.attributes?.[CONFIG.incidentField]?.trim())
            .filter(Boolean)
        )].sort();

        DOM.countBadge.textContent = names.length;
        if (names.length) {
          DOM.countBadge.classList.add('has-incidents');
        } else {
          DOM.noIncidentsMsg.style.display = 'block';
        }

        const frag = document.createDocumentFragment();
        for (const name of names) {
          const chip = createChip(name, () => {
            const url = new URL(location.href);
            url.searchParams.set('incident', name);
            location.href = url;
          });
          if (name === INCIDENT) chip.classList.add('active');
          frag.appendChild(chip);
        }
        DOM.chipsEl.appendChild(frag);
      } catch (err) {
        console.error('Error loading incidents:', err);
        DOM.countBadge.textContent = '0';
      }
    }

    async function loadEvacuationZones() {
      if (!INCIDENT) { showHelp(); return; }

      const where = `${CONFIG.incidentField}='${escapeQuery(INCIDENT)}' AND STATUS IN ('${CONFIG.statusValues.SET}','${CONFIG.statusValues.GO}')`;
      const params = new URLSearchParams({ where, outFields: '*', f: 'geojson', returnGeometry: 'false' });

      try {
        const res = await fetch(`${CONFIG.featureServiceUrl}/query?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.features?.length) {
          DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
            <div class="evac-title">No Active Zones</div>
            <div class="evac-body">No evacuation zones are currently active for <strong>${INCIDENT}</strong>.</div>
          </div>`;
          return;
        }

        const setFeatures = data.features.filter(f => f.properties.STATUS === CONFIG.statusValues.SET);
        const goFeatures = data.features.filter(f => f.properties.STATUS === CONFIG.statusValues.GO);
        DOM.evacRow.innerHTML = buildBox('SET', setFeatures) + buildBox('GO', goFeatures);
      } catch (err) {
        console.error('Error loading evacuation zones:', err);
        DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#fee">Error loading data</div>`;
      }
    }

    async function loadIncidentStatus() {
      if (!INCIDENT) return;

      try {
        const res = await fetch(`${CONFIG.statusBaseUrl}?incident=${encodeURIComponent(INCIDENT)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();

        DOM.incidentPanel.innerHTML = `<div>${html}</div>
          <div class="status-timestamp">Last loaded: ${new Date().toLocaleString()}</div>`;
      } catch (err) {
        console.error('Error loading incident status:', err);
        DOM.incidentPanel.innerHTML = '<div>Error loading incident status.</div>';
      }
    }

    // ========== PERFORMANCE TRACKING ==========
    function updatePerfBadge() {
      const loadTime = Math.round(performance.now() - startTime);
      const entries = performance.getEntriesByType('resource');
      const jsSize = entries
        .filter(e => e.name.includes('leaflet') || e.name.includes('esri'))
        .reduce((sum, e) => sum + (e.transferSize || 0), 0);
      
      DOM.perfBadge.innerHTML = `
        <div>⚡ Leaflet Version</div>
        <div style="margin-top:4px;font-size:11px;opacity:0.9">
          JS: ~${Math.round(jsSize / 1024)}KB vs ~2,500KB<br>
          Init: ${loadTime}ms
        </div>
      `;
    }

    // ========== INIT ==========
    function init() {
      DOM.evacRow = $('evacRow');
      DOM.incidentPanel = $('incidentPanel');
      DOM.chipsEl = $('incidentChips');
      DOM.countBadge = $('incidentCountBadge');
      DOM.noIncidentsMsg = $('noIncidentsMsg');
      DOM.perfBadge = $('perfBadge');

      $('infoButton')?.addEventListener('click', () => location.href = 'info.html');
      $('overviewButton')?.addEventListener('click', () => location.href = 'overview.html');

      // Run all in parallel
      Promise.all([
        loadIncidents(),
        loadEvacuationZones(),
        loadIncidentStatus()
      ]).then(updatePerfBadge);

      initMap();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
